<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Constraint-to-Plan Studio</title>
  <link rel="stylesheet" href="../../common.css" />
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root{--bg:#091224;--panel:#0f1f39;--line:rgba(255,255,255,.16);--text:#e8f0ff;--muted:#9db4df;--accent:#68e1ff;--good:#38d57b;--warn:#ffc967;--bad:#ff6f7f;--mono:ui-monospace,Menlo,Consolas,monospace}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,sans-serif}
    .back-link{padding:8px 12px}.back-link a{color:var(--accent)}
    header{padding:12px;border-bottom:1px solid var(--line)} h1{margin:0;font-size:18px} p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .layout{display:grid;grid-template-columns:320px 1fr 1fr;gap:10px;padding:10px;max-width:1500px;margin:0 auto}
    .card{border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));overflow:hidden}
    .hd{padding:10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:8px}.bd{padding:10px}
    .title{font-weight:800}.mono{font-family:var(--mono)} .hint{color:var(--muted);font-size:12px}
    .btn,.pill{border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);border-radius:8px;padding:8px 10px;font-weight:700;cursor:pointer}
    .btn:hover,.pill:hover{border-color:rgba(255,255,255,.34)} .btn.primary{border-color:rgba(104,225,255,.45)} .btn.good{border-color:rgba(56,213,123,.5)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}.grid{display:grid;gap:8px} .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    input,textarea,select{width:100%;background:rgba(255,255,255,.03);color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px;font-family:var(--mono);font-size:12px}
    textarea{min-height:95px;resize:vertical}
    .pill.active{outline:2px solid rgba(104,225,255,.55)}
    .cands{display:grid;gap:8px;max-height:290px;overflow:auto} .cand{border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;background:rgba(0,0,0,.2)}
    .cand.active{outline:2px solid rgba(104,225,255,.5)}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}.tab{border:1px solid var(--line);padding:6px 9px;border-radius:999px;cursor:pointer;font-size:12px}.tab.active{background:rgba(104,225,255,.16)}
    .panel{border:1px solid var(--line);border-radius:10px;padding:8px;min-height:310px;background:rgba(0,0,0,.16)}
    .tree ul{margin:4px 0 4px 18px;padding:0} .tree li{margin:3px 0}
    .timeline-row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center;margin:8px 0}.track{height:13px;border:1px solid var(--line);border-radius:99px;position:relative}
    .bar{position:absolute;height:100%;border-radius:99px;background:rgba(104,225,255,.52)}
    .kanban{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.col{border:1px solid var(--line);border-radius:10px;padding:8px}.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 7px;font-size:11px;margin-bottom:6px}
    .activity{border:1px solid var(--line);border-radius:8px;padding:7px;margin:6px 0;background:rgba(255,255,255,.03)} .activity h4{margin:0 0 5px;font-size:13px}
    .explain{font-size:11px;color:var(--muted);line-height:1.3}
    .compare{display:grid;grid-template-columns:1fr 1fr;gap:8px}.warn{color:var(--warn)}
    svg{width:100%;height:220px;border:1px solid var(--line);border-radius:10px;background:rgba(0,0,0,.2)}
    @media (max-width:1200px){.layout{grid-template-columns:1fr}.compare{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="back-link"><a href="../../index.html">Back to app index</a></div>
<header>
  <h1>Constraint-to-Plan Studio</h1>
  <p>Petri net → candidate trace generation → compiled WBS, dependency graph, timeline, kanban, and decision log with explanation cards.</p>
</header>

<div class="layout">
  <section class="card">
    <div class="hd"><div class="title">Model & constraints</div><div id="status" class="hint">Ready</div></div>
    <div class="bd grid">
      <div class="grid2">
        <label>Search depth<input id="maxDepth" type="number" min="1" max="30" value="10"></label>
        <label>Max states<input id="maxStates" type="number" min="10" max="20000" value="4000"></label>
      </div>
      <label>Goal marking JSON<textarea id="goal">{"complete":1}</textarea></label>
      <label>Petri net JSON (editable)<textarea id="netEditor"></textarea></label>
      <div class="row">
        <button id="btnValidate" class="btn">Validate invariants</button>
        <button id="btnReach" class="btn">Run reachability</button>
        <button id="btnGenerate" class="btn primary">Generate candidates</button>
        <button id="btnExport" class="btn good">Export artefacts</button>
      </div>
      <div class="row">
        <button class="pill" data-layer="theory">Theory</button>
        <button class="pill" data-layer="howto">How-to</button>
        <button class="pill" data-layer="director">Project-director practical</button>
      </div>
      <div id="explainer" class="hint"></div>
      <div class="hint">Petri net diagram</div>
      <svg id="netSvg" aria-label="Petri net diagram"></svg>
    </div>
  </section>

  <section class="card">
    <div class="hd"><div class="title">Candidate plans</div><div id="meta" class="mono hint">0 candidates</div></div>
    <div class="bd grid">
      <div class="cands" id="candidateList"></div>
      <div class="card" style="border-radius:10px">
        <div class="hd"><div class="title">Branch explorer</div></div>
        <div class="bd">
          <label>Fork from candidate<select id="branchCandidate"></select></label>
          <label>Step index<select id="branchStep"></select></label>
          <label>Choose next enabled transition<select id="branchTransition"></select></label>
          <div class="row"><button id="btnFork" class="btn">Fork candidate</button></div>
          <div id="branchHint" class="hint"></div>
        </div>
      </div>
      <div class="hint">Reachability mini-map</div>
      <svg id="miniMap" aria-label="reachability map"></svg>
      <div class="compare" id="compare"></div>
    </div>
  </section>

  <section class="card">
    <div class="hd"><div class="title">Artefacts</div></div>
    <div class="bd grid">
      <div class="tabs" id="tabs"></div>
      <div class="panel" id="artefactPanel"></div>
    </div>
  </section>
</div>

<script>
const defaultNet = {
  places:[
    {id:"permit",label:"Permit",kind:"condition",tokens:1,wipLimit:1},
    {id:"crew",label:"Crew",kind:"resource",tokens:2,wipLimit:2},
    {id:"site_ready",label:"Site Ready",kind:"deliverable",tokens:0},
    {id:"materials",label:"Materials",kind:"resource",tokens:0,wipLimit:1},
    {id:"built",label:"Built",kind:"deliverable",tokens:0},
    {id:"complete",label:"Complete",kind:"goal",tokens:0}
  ],
  transitions:[
    {id:"prep",label:"Prepare site",pre:{permit:1,crew:1},post:{site_ready:1,permit:1,crew:1},annotations:{workPackage:"Readiness",cost:2,risk:1}},
    {id:"deliver",label:"Deliver materials",pre:{permit:1,crew:1},post:{materials:1,permit:1,crew:1},annotations:{workPackage:"Logistics",cost:3,risk:1}},
    {id:"build",label:"Build shelter",pre:{site_ready:1,materials:1,crew:1},post:{built:1,crew:1},annotations:{workPackage:"Construction",cost:8,risk:3}},
    {id:"inspect",label:"Inspect",pre:{built:1},post:{complete:1},annotations:{workPackage:"Governance",cost:1,risk:1}}
  ],
  goals:[{"complete":1}]
};

const state = {net:structuredClone(defaultNet), candidates:[], selected:0, tab:"WBS", decisionLog:[], graph:null};
const tabs = ["WBS","Timeline","Kanban","Dependencies","Decision log"];

function keyOf(m){ return state.net.places.map(p=>m[p.id]||0).join(","); }
function parseGoal(){ return JSON.parse(document.getElementById("goal").value); }
function initialMarking(){ const m={}; state.net.places.forEach(p=>m[p.id]=p.tokens||0); return m; }
function enabledTransitions(m){ return state.net.transitions.filter(t=>Object.entries(t.pre).every(([k,v])=>(m[k]||0)>=v)); }
function fire(m,t){ const n=structuredClone(m); Object.entries(t.pre).forEach(([k,v])=>n[k]-=v); Object.entries(t.post).forEach(([k,v])=>n[k]=(n[k]||0)+v); return n; }
function meetsGoal(m,g){ return Object.entries(g).every(([k,v])=>(m[k]||0)>=v); }

function validateNet(){
  try {
    const parsed = JSON.parse(document.getElementById("netEditor").value);
    if(!Array.isArray(parsed.places) || !Array.isArray(parsed.transitions)) throw new Error("Need places[] and transitions[]");
    state.net = parsed;
    const pSet = new Set(parsed.places.map(p=>p.id));
    parsed.transitions.forEach(t=>{
      [...Object.keys(t.pre||{}),...Object.keys(t.post||{})].forEach(pid=>{ if(!pSet.has(pid)) throw new Error(`Transition ${t.id} references unknown place ${pid}`); });
    });
    setStatus("Net valid", "ok");
    drawNet();
    return true;
  } catch (e){ setStatus("Validation failed: "+e.message, "bad"); return false; }
}

function enumerateCandidates(goal,{maxDepth,maxStates}){
  const M0 = initialMarking(), k0 = keyOf(M0), seen = new Map([[k0,{m:M0,depth:0,prev:null,via:null}]]), q=[k0], edges=[], hits=[];
  while(q.length){
    const k=q.shift(), n=seen.get(k); if(!n) continue;
    if(meetsGoal(n.m,goal)) hits.push(k);
    if(n.depth>=maxDepth) continue;
    for(const t of enabledTransitions(n.m)){
      const m2=fire(n.m,t), k2=keyOf(m2); edges.push({source:k,target:k2,label:t.id});
      if(!seen.has(k2)){ if(seen.size>=maxStates) return {seen,edges,hits,truncated:true}; seen.set(k2,{m:m2,depth:n.depth+1,prev:k,via:t.id}); q.push(k2); }
    }
  }
  return {seen,edges,hits,truncated:false};
}

function reconstruct(k, seen){
  const seq=[], markings=[]; let cur=k;
  while(cur){ const n=seen.get(cur); markings.push(n.m); if(n.via) seq.push(n.via); cur=n.prev; }
  return {traceId:crypto.randomUUID(), sequence:seq.reverse(), markings:markings.reverse()};
}

function compileTrace(trace){
  const tBy = Object.fromEntries(state.net.transitions.map(t=>[t.id,t]));
  const deps=[];
  for(let i=0;i<trace.sequence.length;i++){ for(let j=i+1;j<trace.sequence.length;j++){ deps.push([trace.sequence[i],trace.sequence[j]]); }}
  const wpMap = new Map();
  trace.sequence.forEach(tid=>{ const t=tBy[tid], wp=t.annotations?.workPackage||"General"; if(!wpMap.has(wp)) wpMap.set(wp,[]); wpMap.get(wp).push(t); });
  const wbs = {id:"root",title:"Plan candidate",type:"deliverable",children:[...wpMap.entries()].map(([wp,list])=>({id:wp,title:wp,type:"workPackage",children:list.map(t=>({id:t.id,title:t.label,type:"task",evidence:buildEvidence(t,trace.sequence,tBy)}))}))};
  const schedule = trace.sequence.map((tid,i)=>({id:tid,title:tBy[tid].label,start:i,end:i+1,dependsOn:i?[trace.sequence[i-1]]:[],resourcesUsed:Object.keys(tBy[tid].pre)}));
  const kanban = {Backlog:schedule.slice(1).map(t=>t.title), "In Progress":schedule.slice(0,1).map(t=>t.title), Done:[]};
  const metrics = {
    steps: trace.sequence.length,
    parallelismScore: Math.max(1, new Set(trace.sequence.map(id=>Object.keys(tBy[id].pre).sort().join("|"))).size),
    resourceSlack: (initialMarking().crew||0)-1,
    riskProxy: trace.sequence.reduce((s,id)=>s+(tBy[id].annotations?.risk||1),0),
    cost: trace.sequence.reduce((s,id)=>s+(tBy[id].annotations?.cost||1),0)
  };
  return {trace, wbs, dependencies:deps, schedule, kanban, metrics};
}

function buildEvidence(t, sequence, tBy){
  const pre=Object.entries(t.pre||{}).map(([k,v])=>`${k}:${v}`).join(", ") || "none";
  const post=Object.entries(t.post||{}).map(([k,v])=>`${k}:${v}`).join(", ") || "none";
  const blocks=sequence.filter(id=>id!==t.id && Object.keys(tBy[id].pre||{}).some(p=>p in (t.post||{})));
  return {
    fromTransitions:[t.id], fromPlaces:[...new Set([...Object.keys(t.pre||{}),...Object.keys(t.post||{})])],
    whyText:`Belongs to ${t.annotations?.workPackage||"General"} because it touches shared interface places and advances goal places.`,
    counterfactualHints:[`Removing ${t.label} would violate preconditions for: ${blocks.join(", ")||"later completion"}.`],
    preconditions:pre, postconditions:post
  };
}

function setStatus(msg, kind){ const el=document.getElementById("status"); el.textContent=msg; el.className = `hint ${kind==="bad"?"warn":""}`; }

function renderCandidates(){
  const root=document.getElementById("candidateList"); root.innerHTML="";
  state.candidates.forEach((c,idx)=>{
    const d=document.createElement("div"); d.className="cand"+(idx===state.selected?" active":"");
    d.innerHTML=`<div><b>${idx+1})</b> ${c.trace.sequence.join(" → ")||"(goal already met)"}</div><div class="hint">steps ${c.metrics.steps} · risk ${c.metrics.riskProxy} · cost ${c.metrics.cost}</div>`;
    d.onclick=()=>{ state.selected=idx; renderAll(); };
    root.appendChild(d);
  });
  document.getElementById("meta").textContent = `${state.candidates.length} candidates`;
}

function renderTabs(){
  const el=document.getElementById("tabs"); el.innerHTML="";
  tabs.forEach(tab=>{ const b=document.createElement("button"); b.className="tab"+(tab===state.tab?" active":""); b.textContent=tab; b.onclick=()=>{state.tab=tab; renderArtefact();}; el.appendChild(b); });
}

function activityCard(t,e){ return `<div class="activity"><h4>${t.title||t.label}</h4><div class="explain"><b>Requires:</b> ${e.preconditions}<br><b>Produces:</b> ${e.postconditions}<br><b>Justification:</b> ${e.whyText}<br><b>Counterfactual:</b> ${e.counterfactualHints[0]}</div></div>`; }

function renderArtefact(){
  const panel=document.getElementById("artefactPanel"), c=state.candidates[state.selected];
  if(!c){ panel.innerHTML='<div class="hint">Generate and select a candidate.</div>'; return; }
  if(state.tab==="WBS"){
    panel.innerHTML = `<div class="tree">` + c.wbs.children.map(w=>`<div><b>${w.title}</b><ul>${w.children.map(t=>`<li>${activityCard({title:t.title},t.evidence)}</li>`).join("")}</ul></div>`).join("") + `</div>`;
  } else if(state.tab==="Timeline"){
    const max=Math.max(...c.schedule.map(s=>s.end),1);
    panel.innerHTML = c.schedule.map(s=>`<div class="timeline-row"><div>${s.title}</div><div class="track"><div class="bar" style="left:${(s.start/max)*100}%;width:${((s.end-s.start)/max)*100}%"></div></div></div>`).join("") + `<div class="hint">Ordinal time semantics layer (prototype).</div>`;
  } else if(state.tab==="Kanban"){
    panel.innerHTML = `<div class="kanban">${Object.entries(c.kanban).map(([k,v])=>`<div class="col"><div class="tag">${k} (WIP ${k==='In Progress'? (initialMarking().crew||1):'-'})</div>${v.map(x=>`<div class="activity">${x}</div>`).join('')||'<div class="hint">empty</div>'}</div>`).join("")}</div>`;
  } else if(state.tab==="Dependencies"){
    const sccWarning = new Set(c.dependencies.map(d=>d[0])).size < c.dependencies.length ? "Potential SCC/cycle risk in underlying model" : "DAG projection";
    panel.innerHTML = `<div class="hint ${sccWarning.includes('risk')?'warn':''}">${sccWarning}</div><ul>${c.dependencies.map(d=>`<li class="mono">${d[0]} → ${d[1]}</li>`).join("")}</ul>`;
  } else {
    panel.innerHTML = `<div class="grid">${state.decisionLog.map((r,i)=>`<div class="activity"><b>${i+1}. ${r.decision}</b><div class="hint">${r.rationale}</div></div>`).join("") || '<div class="hint">No decision captured yet.</div>'}<button class="btn" id="captureDecision">Capture selected candidate decision</button></div>`;
    const btn=document.getElementById("captureDecision"); if(btn) btn.onclick=()=>{ const cc=state.candidates[state.selected]; state.decisionLog.push({decision:`Selected ${state.selected+1}`,rationale:`Risk ${cc.metrics.riskProxy}, cost ${cc.metrics.cost}, gates from dependencies reviewed.`}); renderArtefact(); };
  }
}

function renderCompare(){
  const el=document.getElementById("compare");
  if(state.candidates.length<2){ el.innerHTML='<div class="hint">Select at least two candidates to compare (auto compares first two).</div>'; return; }
  const [a,b]=state.candidates;
  el.innerHTML = `<div class="activity"><b>Candidate 1</b><div class="hint">steps ${a.metrics.steps}, risk ${a.metrics.riskProxy}, cost ${a.metrics.cost}</div></div>
  <div class="activity"><b>Candidate 2</b><div class="hint">steps ${b.metrics.steps}, risk ${b.metrics.riskProxy}, cost ${b.metrics.cost}</div></div>`;
}

function renderBranchUI(){
  const cSel=document.getElementById("branchCandidate"), sSel=document.getElementById("branchStep");
  cSel.innerHTML = state.candidates.map((_,i)=>`<option value="${i}">Candidate ${i+1}</option>`).join("");
  const ci=Number(cSel.value||0), c=state.candidates[ci];
  if(!c){ sSel.innerHTML=""; document.getElementById("branchTransition").innerHTML=""; return; }
  sSel.innerHTML = c.trace.markings.map((_,i)=>`<option value="${i}">marking ${i}</option>`).join("");
  updateBranchTransitions();
}

function updateBranchTransitions(){
  const ci=Number(document.getElementById("branchCandidate").value||0), si=Number(document.getElementById("branchStep").value||0);
  const c=state.candidates[ci]; if(!c) return;
  const enabled = enabledTransitions(c.trace.markings[si]||c.trace.markings.at(-1));
  document.getElementById("branchTransition").innerHTML = enabled.map(t=>`<option value="${t.id}">${t.id} — ${t.label}</option>`).join("");
  document.getElementById("branchHint").textContent = enabled.length? `Enabled now: ${enabled.map(t=>t.id).join(", ")}` : "No enabled transitions (deadlock).";
}

function drawNet(){
  const svg = d3.select("#netSvg"); svg.selectAll("*").remove();
  const places=state.net.places.map((p,i)=>({id:p.id,label:p.label,x:90+(i%3)*110,y:45+Math.floor(i/3)*120,type:"place"}));
  const trans=state.net.transitions.map((t,i)=>({id:t.id,label:t.label,x:75+(i%2)*180,y:110+Math.floor(i/2)*95,type:"transition"}));
  const pBy=Object.fromEntries(places.map(p=>[p.id,p]));
  const links=[]; trans.forEach(t=>{ Object.keys(t.pre||{}).forEach(pid=>links.push({a:pBy[pid],b:t})); Object.keys(t.post||{}).forEach(pid=>links.push({a:t,b:pBy[pid]})); });
  svg.selectAll("line").data(links).join("line").attr("x1",d=>d.a.x).attr("y1",d=>d.a.y).attr("x2",d=>d.b.x).attr("y2",d=>d.b.y).attr("stroke","#87a5d7").attr("stroke-opacity",.6);
  svg.selectAll("circle").data(places).join("circle").attr("cx",d=>d.x).attr("cy",d=>d.y).attr("r",20).attr("fill","#183057").attr("stroke","#9ec8ff");
  svg.selectAll("rect").data(trans).join("rect").attr("x",d=>d.x-17).attr("y",d=>d.y-26).attr("width",34).attr("height",52).attr("fill","#2f405f").attr("stroke","#9ec8ff");
  svg.selectAll("text.pl").data(places).join("text").attr("class","pl").attr("x",d=>d.x).attr("y",d=>d.y+35).attr("text-anchor","middle").attr("fill","#d5e5ff").style("font-size","10px").text(d=>`${d.id}(${initialMarking()[d.id]||0})`);
  svg.selectAll("text.tr").data(trans).join("text").attr("class","tr").attr("x",d=>d.x).attr("y",d=>d.y+40).attr("text-anchor","middle").attr("fill","#d5e5ff").style("font-size","10px").text(d=>d.id);
}

function drawMiniMap(graph){
  const svg=d3.select("#miniMap"); svg.selectAll("*").remove();
  if(!graph){ return; }
  const nodes=[...graph.seen.keys()].slice(0,60).map(id=>({id}));
  const nSet=new Set(nodes.map(n=>n.id));
  const links=graph.edges.filter(e=>nSet.has(e.source)&&nSet.has(e.target)).slice(0,120);
  const sim=d3.forceSimulation(nodes).force("link",d3.forceLink(links).id(d=>d.id).distance(28)).force("charge",d3.forceManyBody().strength(-65)).force("center",d3.forceCenter(240,110));
  const l=svg.selectAll("line").data(links).join("line").attr("stroke","#7da2dd").attr("stroke-opacity",.35);
  const c=svg.selectAll("circle").data(nodes).join("circle").attr("r",4).attr("fill",d=>graph.hits.includes(d.id)?"#38d57b":"#b6ccf7");
  sim.on("tick",()=>{ l.attr("x1",d=>d.source.x).attr("y1",d=>d.source.y).attr("x2",d=>d.target.x).attr("y2",d=>d.target.y); c.attr("cx",d=>d.x).attr("cy",d=>d.y); });
}

function renderExplainer(layer){
  const map={
    theory:"A marking is a multiset of tokens; reachability asks if any firing sequence leads to a goal marking.",
    howto:"Edit net/goal, validate, generate candidates, compare traces, inspect artefacts, export JSON.",
    director:"Use candidates to set governance gates, compare cost/risk proxies, and capture the chosen rationale in the decision log."
  };
  document.getElementById("explainer").textContent = map[layer] || "";
  document.querySelectorAll(".pill").forEach(p=>p.classList.toggle("active", p.dataset.layer===layer));
}

function renderAll(){ renderCandidates(); renderTabs(); renderArtefact(); renderCompare(); renderBranchUI(); drawNet(); }

function bind(){
  document.getElementById("btnValidate").onclick=validateNet;
  document.getElementById("btnReach").onclick=()=>{
    if(!validateNet()) return;
    try{ const graph=enumerateCandidates(parseGoal(),{maxDepth:+document.getElementById("maxDepth").value,maxStates:+document.getElementById("maxStates").value}); state.graph=graph; drawMiniMap(graph); setStatus(`Explored ${graph.seen.size} states${graph.truncated?' (truncated)':''}`,'ok'); }
    catch(e){ setStatus(e.message,'bad'); }
  };
  document.getElementById("btnGenerate").onclick=()=>{
    if(!validateNet()) return;
    try{
      const graph=enumerateCandidates(parseGoal(),{maxDepth:+document.getElementById("maxDepth").value,maxStates:+document.getElementById("maxStates").value});
      state.graph=graph;
      state.candidates = graph.hits.slice(0,12).map(k=>compileTrace(reconstruct(k,graph.seen)));
      state.selected = 0;
      drawMiniMap(graph);
      renderAll();
      setStatus(state.candidates.length?`Generated ${state.candidates.length} candidates`:'No candidates','ok');
    }catch(e){ setStatus(e.message,'bad'); }
  };
  document.getElementById("btnExport").onclick=()=>{
    const c=state.candidates[state.selected]; if(!c){ alert("Generate a candidate first"); return; }
    const payload={net:state.net,trace:c.trace,wbs:c.wbs,schedule:c.schedule,dependencies:c.dependencies,decisionLog:state.decisionLog};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}), url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='constraint-to-plan-studio-export.json'; a.click(); URL.revokeObjectURL(url);
  };
  document.querySelectorAll(".pill").forEach(p=>p.onclick=()=>renderExplainer(p.dataset.layer));
  document.getElementById("branchCandidate").onchange=renderBranchUI;
  document.getElementById("branchStep").onchange=updateBranchTransitions;
  document.getElementById("btnFork").onclick=()=>{
    const ci=Number(document.getElementById("branchCandidate").value||0), si=Number(document.getElementById("branchStep").value||0), tid=document.getElementById("branchTransition").value;
    const c=state.candidates[ci]; if(!c||!tid) return;
    const t=state.net.transitions.find(x=>x.id===tid), m=c.trace.markings[si];
    if(!enabledTransitions(m).find(x=>x.id===tid)){ alert("Transition is not enabled at selected step"); return; }
    const newTrace={traceId:crypto.randomUUID(),sequence:[...c.trace.sequence.slice(0,si),tid],markings:[...c.trace.markings.slice(0,si+1),fire(m,t)]};
    state.candidates.push(compileTrace(newTrace));
    renderAll();
    setStatus("Forked candidate added","ok");
  };
}

function init(){
  document.getElementById("netEditor").value = JSON.stringify(defaultNet,null,2);
  renderExplainer("theory");
  bind();
  drawNet();
  renderTabs();
  renderArtefact();
}
init();
</script>
</body>
</html>
